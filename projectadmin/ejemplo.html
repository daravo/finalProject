
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="https://iesdosmares.com/wp-content/uploads/2017/01/favicon.ico"
      type="image/x-icon"
    />
    <title>Examen vue.js</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <style>
      .card {
        border-radius: 1.5rem;
      }

      .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-color: orange;
        cursor: pointer;
      }

      .card-body > p {
        overflow-x: hidden;
      }

      .preview {
        border-radius: 0.5rem;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
        overflow-y: scroll;
      }

      pre {
        white-space: pre-wrap;
      }

      .content-preview {
        font-family: "Courier New", Courier, monospace;
        height: 25vh;
      }

      .wrapper-usuarios-vertical {
        height: 80vh;
        overflow-y: scroll;
        user-select: none;
      }
    </style>
  </head>

  <body>
    <div id="app" class="container-fluid">
      <div class="row">
        <!-- listado de usuarios de la izquierda -->
        <usuarios
          class="col-3 wrapper-usuarios-vertical"
          @anadir="agregar"
          @eliminar="eliminar_de"
          :lista_usuarios="usuarios"
          :posicion="pos_usuarios"
        ></usuarios>

        <div class="col-9">
          <h1 class="text-center">Mini email</h1>

          <hr />
          <p>Vista previa</p>
          <!-- preview -->
          <preview
            :titulo="titulo"
            :mensaje="mensaje"
            :destinatarios="emails"
          ></preview>
          <p>Destinatarios: {{emails.length}}</p>

          <usuarios
            @eliminar="eliminar_de"
            @anadir="agregar"
            class="row row-cols-5"
            :lista_usuarios="destinatarios"
            :posicion="pos_destinatarios"
          ></usuarios>

          <barra-progreso
            :max="max_destinatarios"
            :usuarios="emails.length"
          ></barra-progreso>

          <!-- formulario -->
          <form @submit.prevent>
            <label for="titulo" class="form-label">Título</label>
            <input
              :class="{'is-invalid':!titulo}"
              v-model="titulo"
              class="form-control"
              type="text"
              id="titulo"
              placeholder="Título..."
            />

            <label class="form-label" for="mensaje">Mensaje</label>
            <textarea
              :class="{'is-invalid':!mensaje}"
              v-model="mensaje"
              class="form-control"
              name="mensaje"
              id="mensaje"
              cols="30"
              rows="10"
            ></textarea>
            <br />
            <button
              v-if="emails.length>0"
              type="submit"
              class="form-control btn btn-primary"
              @click="validar"
            >
              Enviar
            </button>
          </form>
          <!-- Modal -->
          <div class="modal fade" id="notificacion">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="notificacionLabel">
                    Email enviado con éxito
                  </h5>
                  <button
                    @click="reiniciar"
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <h2>Título</h2>
                  <pre>{{titulo}}</pre>
                  <h2>Mensaje</h2>
                  <pre>{{mensaje}}</pre>
                </div>
                <div class="modal-footer">
                  <button
                    @click="reiniciar"
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Cerrar
                  </button>
                </div>
              </div>
            </div>
          </div>
          <hr />
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <!-- * Barra de progreso * -->
    <script type="text/x-template" id="barra-template">
      <div class="progress m-2">
        <div class="progress-bar" :style="{width: total}" :class="fondo">{{total}}</div>
      </div>
    </script>

    <!-- * Vista previa * -->
    <script type="text/x-template" id="preview-template">
      <div class="preview">
        <div class="content-preview border border-2" :class="borde">
          Email to: {{destinatarios}}
          <pre class="text-success">{{titulo}}</pre>
          <pre>{{mensaje}}</pre>
        </div>
      </div>
    </script>

    <!-- * Usuario * -->
    <script type="text/x-template" id="usuario-template">
      <div class="card mb-1 ps-0" @click="usuario_clickado" @contextmenu.prevent="preguntar">
        <div class="row g-0">
          <div class="col-3">
            <img
              :src="datos.foto"
              class="img-fluid rounded-circle"

            />
          </div>
          <div class="col-9">
            <div class="card-body p-0">
              <p class="card-text mb-0 text-truncate">{{nombre_completo}}</p>
              <p class="card-text text-secondary text-truncate">{{datos.username}}</p>
            </div>
          </div>
        </div>
      </div>
    </script>

    <!-- * Usuarios * -->
    <script type="text/x-template" id="usuarios-template">
        <div class="container">
          <usuario @selec_eliminar=enviar_eliminar  @seleccionado="mover" v-for="usuario in lista_ordenada" :key="usuario.username" :datos="usuario"></usuario>
      </div>
    </script>

    <script>
      //! Barra de progreso
      Vue.component("barra-progreso", {
        template: "#barra-template",
        props: ["usuarios", "max"],
        computed: {
          total() {
            return Math.floor((this.usuarios * 100) / this.max) + "%";
          },
          fondo() {
            if (this.usuarios < this.max) {
              return "bg-success";
            } else {
              return "bg-danger";
            }
          },
        },
        methods: {},
      });

      //! Usuarios
      Vue.component("usuarios", {
        template: "#usuarios-template",
        props: ["lista_usuarios", "posicion"],
        computed: {
          lista_ordenada() {
            return this.lista_usuarios.sort(function (x, y) {
              if (x.nombre < y.nombre) {
                return -1;
              }
              if (x.nombre > y.nombre) {
                return 1;
              }
              return 0;
            });
          },
        },
        methods: {
          mover(objeto) {
            //esta función recibe un objeto de usuario
            this.$emit("anadir", objeto, this.posicion); //le paso de qué listado(izquierda o derecha) viene el usuario y el objeto con todos los datos de usuario
          },
          enviar_eliminar(objeto) {
            this.$emit("eliminar", objeto, this.posicion); //paso un evento al root con el objeto que debe eliminar y la lista a la cual pertenece
          },
        },
      });

      //! Usuario
      Vue.component("usuario", {
        template: "#usuario-template",
        props: ["datos"], //Recibe los datos de los usuarios
        computed: {
          nombre_completo() {
            return this.datos.nombre + " " + this.datos.apellido;
          },
        },
        methods: {
          usuario_clickado() {
            this.$emit("seleccionado", this.datos); //mando el objeto que contiene los datos del usuario con el emit
            console.log(this.datos);
          },
          preguntar() {
            while (true) {
              //En este bucle controlo que me seleccionan lo que quiero
              let opcion = prompt(
                "¿Seguro que quieres eliminar definitivamente el usuario " +
                  this.datos.username +
                  "?\n1. Sí, estoy segur@\n2. No"
              );
              if (opcion == "1") {
                this.$emit("selec_eliminar", this.datos); //Si confirman la eliminación, le pasamos al padre un evento para cargarnos el usuario definitivamente
                break;
              } else if (opcion == "2") {
                break;
              } else {
                alert("Opción no válida, teclee 1 ó 2 en las opciones");
              }
            }
          },
        },
      });

      //! Preview
      Vue.component("preview", {
        template: "#preview-template",
        props: ["titulo", "mensaje", "destinatarios"],
        computed: {
          borde() {
            if (this.destinatarios.length == 0) {
              return "border-danger";
            }
          },
        },
      });

      let vm = new Vue({
        el: "#app",
        data: {
          titulo: "",
          mensaje: "",
          emails: [],
          max_destinatarios: 10,
          usuarios: [], //En esta lista almaceno TODOS los usuarios
          destinatarios: [],
          pos_usuarios: "izquierda", //Esta es la posición de las listas para saber de dónde viene cada usuario
          pos_destinatarios: "derecha",
        },

        methods: {
          validar() {
            if (this.destinatarios.length === 0) {
              return alert("Debes añadir por lo menos un destinatario");
            }
            if (this.titulo === "") {
              return alert("El mensaje debe contener algún título");
            }
            if (this.mensaje === "") {
              return alert("No has escrito ningún mensaje");
            }
            //Si llega hasta aquí es porque ha pasado todas las validaciones y procederé a crear el modal:
            var modalEmail = new bootstrap.Modal(
              document.getElementById("notificacion")
            );
            //entonces enseño el modal
            modalEmail.show();
          },
          reiniciar() {
            //Limpio formulario:
            this.titulo = "";
            this.mensaje = "";
            //Limpio listado de emails:
            this.emails = [];
            //Regreso todos los destinatarios al listado de usuarios
            for (let i = this.destinatarios.length - 1; i >= 0; i--) {
              this.usuarios.unshift(this.destinatarios[i]);
              this.destinatarios.splice(i, 1);
            }
          },
          agregar(objeto, posicion) {
            /*Esta función debe comprobar de qué lista le llega el objeto
            para ello uso la variable posición, si le llega de usuarios hay que comprobar el límite de destinatarios*/
            if (posicion === this.pos_usuarios) {
              if (this.destinatarios.length < this.max_destinatarios) {
                let indice = this.usuarios.findIndex(
                  (elemento) => elemento.username === objeto.username
                ); //con esta posición puedo borrar el objeto del array
                this.destinatarios.unshift(objeto);
                this.usuarios.splice(indice, 1);
                this.emails.push(objeto.email);
              } else {
                let mensaje =
                  "No puedes añadir más de " +
                  this.max_destinatarios +
                  " destinatarios";
                alert(mensaje);
              }
            } else if (posicion === this.pos_destinatarios) {
              //si entra en este else, es porque viene del listado de destinatarios el objeto
              let indice = this.destinatarios.findIndex(
                (elemento) => elemento.username === objeto.username
              ); //con esta posición puedo borrar el objeto del array

              let indiceMail = this.emails.findIndex(
                (elemento) => elemento === objeto.email
              ); //Con este otro índice encuentro dónde está el correo
              this.usuarios.unshift(objeto);
              this.destinatarios.splice(indice, 1);
              this.emails.splice(indiceMail, 1);
            }
          },
          eliminar_de(objeto, posicion) {
            if (posicion === this.pos_usuarios) {
              let indice = this.usuarios.findIndex(
                (elemento) => elemento.username === objeto.username
              );
              this.usuarios.splice(indice, 1);
            } else {
              let indice = this.destinatarios.findIndex(
                (elemento) => elemento.username === objeto.username
              );
              let indiceMail = this.emails.findIndex(
                (elemento) => elemento === objeto.email
              ); //Con este otro índice encuentro dónde está el correo

              this.destinatarios.splice(indice, 1); //elimino del array destinatarios
              this.emails.splice(indiceMail, 1); //elimino del array emails
            }
          },
        },
        mounted() {
          axios
            .get("https://randomuser.me/api?results=25")
            .then(
              (response) =>
                (this.usuarios = response.data.results.map((usuario) => {
                  return {
                    nombre: usuario.name.first,
                    apellido: usuario.name.last,
                    email: usuario.email,
                    username: usuario.login.username,
                    foto: usuario.picture.thumbnail,
                  };
                }))
            )
            .catch((error) => console.log(error));
        },
      });
    </script>
  </body>
</html>
